{% extends "base.html" %}
{% block content %}
<div class="card card-modern p-3">
  <h5>فاتورة مشتريات</h5>
  <div class="mb-3">
    <label>اختيار الأصناف</label>
    <div id="items-list" class="mb-2">
      {% for it in query('SELECT * FROM items') %}
        <div class="d-flex align-items-center mb-1">
          <div style="width:40%">{{ it['name'] }} ({{ it['category'] }})</div>
          <input type="number" min="0" placeholder="كمية" data-id="{{ it['id'] }}" class="form-control qty-field" style="width:20%; margin-left:8px;">
          <input type="number" min="0" placeholder="سعر شراء" data-id="{{ it['id'] }}" class="form-control buy-field" style="width:30%; margin-left:8px;">
        </div>
      {% endfor %}
    </div>
    <button id="save-purchase" class="btn btn-success">حفظ فاتورة مشتريات</button>
  </div>
  <hr>
  <h6>سجل فواتير المشتريات</h6>
  <table class="table table-sm">
    <thead><tr><th>التاريخ</th><th>المجموع</th></tr></thead>
    <tbody>
    {% for p in purchases %}
      <tr><td>{{ p['created_at'] }}</td><td>{{ p['total'] }}</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>
<script>
$(function(){
  $('#save-purchase').click(function(){
    let items = [];
    $('.qty-field').each(function(){
      let id = $(this).data('id');
      let qty = parseInt($(this).val()||0);
      let buy = parseFloat($('.buy-field[data-id="'+id+'"]').val()||0);
      if(qty>0 && buy>0) items.push({id:id, qty:qty, buy_price:buy});
    });
    if(items.length==0){ alert('اختر عناصر وادخل كمية وسعر'); return; }
    $.ajax({url:'/purchases/new', method:'POST', contentType:'application/json', data: JSON.stringify({items: items}), success:function(res){
      location.reload();
    }});
  });
});
</script>
{% endblock %}
